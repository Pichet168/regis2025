<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAMA DAY 2025 | ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô E-Ticket</title>
    <script type="module">
        // Import Functions ‡∏à‡∏≤‡∏Å Firebase Module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION ---        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // LIFF ID (‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏≤)        
        const LIFF_ID = '2008409271-X2NQjo64';                 
        
        // Firebase Config (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ)        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCIHxjXkIRylxb_NuUMv3nhcUbreJDQ2Y8",
            authDomain: "e-ticket-6d12d.firebaseapp.com",
            projectId: "e-ticket-6d12d",
            storageBucket: "e-ticket-6d12d.firebasestorage.app",
            messagingSenderId: "994163127757",
            appId: "1:994163127757:web:11e805d527c97fb5a38084",
            measurementId: "G-800M0XN662"
        };                
        
        // Initialize Firebase        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        setLogLevel('Debug'); 
        
        // --- STATE & UI ELEMENTS ---        
        let currentUserId = crypto.randomUUID(); 
        let isFirebaseAuthReady = true; 
        let isLineConnected = false;
        
        const form = document.getElementById('registrationForm');        
        const lineStatusMessage = document.getElementById('lineStatusMessage');        
        const lineUserIdInput = document.getElementById('lineUserId');        
        const submitButton = document.getElementById('submitButton');        
        const feedbackMessage = document.getElementById('feedbackMessage');        
        const currentUrlDisplay = document.getElementById('currentUrlDisplay');                
        
        // --- UTILITY: FEEDBACK MESSAGE ---        
        function showFeedback(message, type = 'info') {
            feedbackMessage.textContent = message;
            feedbackMessage.className = `feedback-box feedback-${type}`;
            feedbackMessage.style.display = 'block';
        }        
        function hideFeedback() {
            feedbackMessage.style.display = 'none';
        }
        
        // --- 1. SETUP (Initialization Entry Point) ---        
        function setupApp() {
            // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LIFF ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢ LINE In-App Browser ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (typeof window.liff === 'undefined') { 
                console.error("LIFF SDK failed to load. (LIFF SDK not defined). Please check that the Endpoint URL is correct and you are using the LIFF URL to launch.");
                lineStatusMessage.textContent = '‚ùå LIFF: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL/‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF)';
                lineStatusMessage.style.color = '#dc3545';
                showFeedback('‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Endpoint URL ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ LINE', 'error');
                return;
            }
            initializeLIFF();         
        }

        // --- 2. LIFF & LINE AUTO-CONNECT LOGIC ---        
        async function initializeLIFF() {                        
            let currentUrl = window.location.href;
            const hashIndex = currentUrl.indexOf('#');
            if (hashIndex !== -1) {
                currentUrl = currentUrl.substring(0, hashIndex);
                history.replaceState(null, null, currentUrl);
            }
            
            currentUrlDisplay.textContent = `URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${currentUrl}`;                        
            
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ liff.init() ‡∏ú‡πà‡∏≤‡∏ô window.liff
                await window.liff.init({ liffId: LIFF_ID });
                console.log("LIFF initialized successfully.");
                                
                if (window.liff.isLoggedIn()) {
                    await getUserProfile();
                } else {
                    lineStatusMessage.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...';
                    lineStatusMessage.style.color = '#ffc107';
                                        
                    window.liff.login({ redirectUri: currentUrl }); 
                }
                            
            } catch (error) {
                console.error("LIFF initialization failed:", error);
                lineStatusMessage.textContent = '‚ùå LIFF: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL/Permissions)';
                lineStatusMessage.style.color = '#dc3545';
                showFeedback('‚ùå LIFF: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö URL ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏Å‡∏±‡∏ö Endpoint URL ‡πÉ‡∏ô Console', 'error');
            } finally {
                checkFormValidity();
            }
        }
        
        async function getUserProfile() {
            try {
                const profile = await window.liff.getProfile();
                const userId = profile.userId;
                                
                lineUserIdInput.value = userId;
                isLineConnected = true;
                                
                lineStatusMessage.textContent = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)';
                lineStatusMessage.style.color = '#28a745';
                checkFormValidity();
            
            } catch (error) {
                console.error("Error getting profile:", error);
                lineStatusMessage.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á User ID ‡πÑ‡∏î‡πâ';
                lineStatusMessage.style.color = '#dc3545';
                showFeedback('‚ùå LIFF: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á Re-authenticate)', 'error');
                isLineConnected = false;
                checkFormValidity();
            }
        }
        
        // --- 3. FORM VALIDATION AND SUBMISSION ---        
        function checkFormValidity() {
            const requiredInputs = form.querySelectorAll('input[required]');
            let allFieldsFilled = true;
                        
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    allFieldsFilled = false;
                }
            });
            
            submitButton.disabled = !(allFieldsFilled && isLineConnected && isFirebaseAuthReady);
                        
            if(!isLineConnected) {                 
                submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE...';
            } else if (!allFieldsFilled) {                 
                submitButton.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
            } else {                 
                submitButton.textContent = '‡∏£‡∏±‡∏ö E-Ticket';
            }
        }
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideFeedback();
                        
            if (submitButton.disabled) {
                showFeedback('‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE', 'warning');
                return;
            }
            
            const formData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                lineUserId: lineUserIdInput.value, 
                ticketType: 'GAMA DAY',
                eventName: 'GAMA DAY 2025',
                eventDateTime: 'Sat Feb 22, 2025 8:30 AM - 5:30 PM',
                status: 'REGISTERED',
                registrationTimestamp: new Date().toISOString()
            };
            
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πã‡∏ß...';
            submitButton.disabled = true;
            
            try {
                const collectionPath = `artifacts/${appId}/users/${currentUserId}/registrations`;
                await addDoc(collection(db, collectionPath), formData);
                
                showFeedback('‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! E-Ticket ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE Official Account ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', 'success');
                submitButton.textContent = '‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                form.reset();                             
            } catch (error) {
                console.error('Error saving registration to Firestore:', error);
                showFeedback('‚ùå ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                submitButton.textContent = originalButtonText;
            } finally {
                checkFormValidity();
            }
        });
        
        // 4. Initial Call & Event Listeners        
        form.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', checkFormValidity);
        });
                
        window.onload = setupApp;    
    </script>
    <style>
        /* CSS styles remain the same for aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #007bff;
            --bg-color: #f7f7f7;
            --container-bg: #ffffff;
            --border-color: #ccc;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
            margin: 0;
        }

        .registration-container {
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            max-width: 450px;
            width: 100%;
            text-align: center;
        }

        /* Typography */
        h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        h2 {
            font-size: 1.4em;
            font-weight: 600;
            color: #444;
            margin-top: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            display: inline-block;
        }

        /* Event Details */
        .event-details {
            background-color: #f0f8ff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 35px;
            font-size: 0.95em;
            text-align: left;
            border-left: 5px solid var(--primary-color);
        }

        .event-details p {
            margin: 5px 0;
            line-height: 1.4;
        }

        .event-details strong {
            font-weight: 600;
        }

        /* Input Fields */
        input {
            width: 100%;
            padding: 14px 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
            outline: none;
        }

        /* LINE Status Section */
        .line-status-box {
            margin: 30px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #lineStatusMessage {
            font-size: 0.95em;
            font-weight: 600;
            color: #333;
        }

        #currentUrlDisplay {
            font-size: 0.75em;
            color: #888;
            word-break: break-all;
            margin-top: 10px;
        }

        /* Submit Button */
        .submit-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 700;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .submit-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .submit-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Feedback Box (New) */
        .feedback-box {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
            font-weight: 500;
            font-size: 0.95em;
        }

        .feedback-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .terms {
            font-size: 0.75em;
            color: #999;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="registration-container">
        <header>
            <h1>GAMA DAY 2025</h1>
            <p class="subtitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö E-Ticket ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</p>
        </header>

        <div id="feedbackMessage" class="feedback-box"></div>

        <div class="event-details">
            <p><strong>üóìÔ∏è ‡∏á‡∏≤‡∏ô:</strong> GAMA DAY</p>
            <p><strong>‚è∞ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤:</strong> Sat Feb 22, 2025 | 8:30 AM - 5:30 PM</p>
        </div>

        <form id="registrationForm">
            <h2>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>

            <input type="text" id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
            <input type="text" id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
            <input type="email" id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" required>
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠" required>

            <div class="line-status-box">
                <p>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πã‡∏ß‡∏à‡∏∞‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô LINE Official Account</p>
                <p id="lineStatusMessage">...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</p>
                <p id="currentUrlDisplay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL...</p>
                <input type="hidden" id="lineUserId" name="lineUserId" value="">
            </div>

            <button type="submit" class="submit-button" id="submitButton" disabled>
            ‡∏£‡∏±‡∏ö E-Ticket        </button>

            <p class="terms">‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
        </form>
    </div>
</body>

</html>
